<!DOCTYPE html>
<html>
<head>
<title>Eeron Dashboard</title>
<meta charset="utf-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

<style>
body {
    width: 100%
}
.video-1, .video-2, .img {
    display: none;
    height: 100%
}
#left, #right {
    position: absolute;
    height: 100vh;
    top: 0;
}
#left {
    left: 0;
}
#right {
    right: 0;
}
#right * {
    float: right
}
</style>
</head>
<body>
<div id="left">
    <video class="video-1" muted loop>
    <source src="" type="">
    </video>
    <video class="video-2" muted loop>
    <source src="" type="">
    </video>
    <img class="img">
    </img>
</div>
<div id="right">
    <video class="video-1" muted loop>
    <source src="" type="">
    </video>
    <video class="video-2" muted loop>
    <source src="" type="">
    </video>
    <img class="img">
    </img>
</div>
<script>
var changeSecs = 10;
var nextMedia;
var turn = 'left';  // Which image/video will change
var boxes = [];
function initBoxes() {
    boxes = [
        {
            id: "left",
            currMedia: null,
            nextMedia: null,
            offset: 0,
            videoIndex: "video-1",
            prevChange: null,  // Last changed
        },
        {
            id: "right",
            currMedia: null,
            nextMedia: null,
            videoIndex: "video-1",
            prevChange: null,  // Last changed
        },
    ]
}
function buildFullUrl(mediaItem) {
    return mediaItem.baseUrl + "=w2048-h1024";
}
function preloadMediaItem(box) {
    if (box.nextMedia.mimeType.indexOf('image/') === 0) {
        (new Image()).src = buildFullUrl(box.nextMedia);
    } else if (box.nextMedia.mimeType.indexOf('video/') === 0) {
        // Load video in background
        const nextVideoIndex = (box.videoIndex == "video-1") ? "video-2" : "video-1";
        const nextVideoEl = document.querySelector("#" + box.id + " ." + nextVideoIndex)
        nextVideoEl.firstElementChild.setAttribute('src', box.nextMedia.baseUrl + "=dv")
        nextVideoEl.setAttribute('type', box.nextMedia.mimeType)
        nextVideoEl.load()
    }
}

function fetchNext(box) {
    axios.get('/get_image')
        .then(resp => {
            box.nextMedia = resp.data
            preloadMediaItem(box)
        })
}

function mainLoop() {
    try {
    for (let box of boxes) {
        const now = new Date();
        const elapsed = box.prevChange == null ? null : ((now.getTime() - box.prevChange.getTime()) / 1000.0)
        let shouldChange = (box.prevChange == null || elapsed > changeSecs)
        if (box.currMedia && box.currMedia.mimeType.indexOf('video/') === 0) {
            let videoEl = document.querySelector("#" + box.id + " ." + box.videoIndex)
            shouldChange = shouldChange && elapsed > videoEl.duration;
        }
        if (shouldChange && box.nextMedia) {
            box.currMedia = box.nextMedia;
            box.nextMedia = null;
            box.prevChange = new Date();
            let imageEl = document.querySelector("#" + box.id + " .img")
            const prevVideoIndex = box.videoIndex
            let prevVideoEl = document.querySelector("#" + box.id + " ." + prevVideoIndex)
            prevVideoEl.style.display = "none";
            if (prevVideoEl.stop != undefined) {
                prevVideoEl.pause();
                prevVideoEl.firstElementChild.removeAttribute('src'); // empty source
                prevVideoEl.removeAttribute('src'); // empty source
                prevVideoEl.load();
            }
            if (box.currMedia.mimeType.indexOf('video/') === 0) {
                const nextVideoIndex = (box.videoIndex == "video-1") ? "video-2" : "video-1";
                box.videoIndex = nextVideoIndex;
                let videoEl = document.querySelector("#" + box.id + " ." + box.videoIndex)
                imageEl.style.display = "none";
                videoEl.style.display = 'inline';
                videoEl.play()
            } else {
                imageEl.style.display = "inline";
                imageEl.setAttribute('src', buildFullUrl(box.currMedia))
            }
            fetchNext(box)
        }
    }
    } catch (err) {
        initBoxes();
        for (let box of boxes) {
            fetchNext(box)
        }
        console.log(err)
    }
    setTimeout(mainLoop, 500)
}

initBoxes();
for (let box of boxes) {
    fetchNext(box)
}
mainLoop()

</script>
</body>
</html>