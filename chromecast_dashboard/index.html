<!DOCTYPE html>
<html>
<head>
<title>Eeron Dashboard</title>
<meta charset="utf-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

  <!-- Post load all the goods used to interact with sender. -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>

<style>
body {
    width: 100%
}
.video-1, .video-2, .img {
    display: none;
    height: 100%
}
.video-1 {
    z-index: 9999;
}
#left, #right {
    position: absolute;
    height: 100vh;
    top: 0;
}
#left {
    left: 0;
}
#right {
    right: 0;
}
#right * {
    float: right
}
span.info {
    position: absolute;
    bottom: 0.5rem;
    right: 1rem;
    color: white;
}
</style>
</head>
<body>
<div id="left">
    <span class="info">Test</span>
    <img class="img">
    </img>
</div>
<div id="right">
    <span class="info">Test</span>
    <img class="img">
    </img>
</div>
<script>

window.onload = function() {
  cast.receiver.logger.setLevelValue(0);
  window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
  console.log('Starting Receiver Manager');

  castReceiverManager.onReady = function(event) {
    console.log('Received Ready event: ' + JSON.stringify(event.data));
    window.castReceiverManager.setApplicationState('chromecast-dashboard is ready...');
  };

  castReceiverManager.onSenderConnected = function(event) {
    console.log('Received Sender Connected event: ' + event.senderId);
  };

  castReceiverManager.onSenderDisconnected = function(event) {
    console.log('Received Sender Disconnected event: ' + event.senderId);
  };

  window.messageBus =
    window.castReceiverManager.getCastMessageBus(
        'urn:x-cast:com.boombatower.chromecast-dashboard', cast.receiver.CastMessageBus.MessageType.JSON);

  window.messageBus.onMessage = function(event) {
    console.log('Message [' + event.senderId + ']: ' + event.data);
  }

  // Initialize the CastReceiverManager with an application status message.
  window.castReceiverManager.start({statusText: 'Application is starting'});
  console.log('Receiver Manager started');


var changeSecs = 10;
var nextMedia;
var turn = 'left';  // Which image/video will change
var boxes = [];
function log(message) {
    console.log(message)
    axios.post('/log', {message})
}

function errorHandler(msg, url, lineNo, columnNo, error) {
    log("Error! " + msg)
}

window.onerror = errorHandler;

function initBoxes() {
    boxes = [
        {
            id: "left",
            currMedia: null,
            nextMedia: null,
            videoIndex: "video-1",
            prevChange: null,  // Last changed
            nextMediaReady: true,
        },
        {
            id: "right",
            currMedia: null,
            nextMedia: null,
            videoIndex: "video-1",
            prevChange: null,  // Last changed
            nextMediaReady: true,
        },
    ]
}
function buildFullUrl(mediaItem) {
    return mediaItem.baseUrl + "=w2048-h1024";
}
function preloadMediaItem(box) {
    if (box.nextMedia.mimeType.indexOf('image/') === 0) {
        (new Image()).src = buildFullUrl(box.nextMedia);
        box.nextMediaReady = true;
        log("Box " + box.id + " (image) nextMedia = " + box.nextMedia.id)
    } else if (box.nextMedia.mimeType.indexOf('video/') === 0) {
        // Load video in background
        const boxEl = document.querySelector('#' + box.id)
        const nextVideoEl = document.createElement('VIDEO')
        nextVideoEl.classList.add('video-1')
        nextVideoEl.setAttribute('loop', '')
        nextVideoEl.setAttribute('muted', '')
        nextVideoEl.setAttribute('src', box.nextMedia.baseUrl + "=dv")
        nextVideoEl.setAttribute('type', box.nextMedia.mimeType)
        boxEl.appendChild(nextVideoEl)
        nextVideoEl.load()
        box.nextMediaReady = false;
        const nextMediaId = box.nextMedia.id
        log("Box " + box.id + " (video) nextMedia = " + nextMediaId)
        nextVideoEl.addEventListener('canplaythrough', function (event) {
            if (box.nextMedia && box.nextMedia.id == nextMediaId) {
                box.nextMediaReady = true;
                log("Box " + box.id + " video nextMediaReady.")
            }
        });
        nextVideoEl.addEventListener('error', function (event) {
            if (box.nextMedia && box.nextMedia.id == nextMediaId) {
                log("Box " + box.id + " video nextMedia error.")
            } else if (box.currMedia && box.currMedia.id == nextMediaId) {
                log("Box " + box.id + " video currMedia error.")
                box.currMedia.error = true;
            }
        });
    }
}

function fetchNext(box) {
    const httpClient = axios.create();
    httpClient.defaults.timeout = 5000;
    let url = '/get_image';
    if (box.id == "right" && box.currMedia && box.currMedia.mimeType.match(/^image/)) {
        url = '/get_video'
    }
    httpClient.get(url)
        .then(resp => {
            console.log(boxes.reduce((acc, box) => acc.concat([(box.currMedia || {}).id, (box.nextMedia || {}).id]), []))
            if (boxes.reduce((acc, box) => acc.concat([(box.currMedia || {}).id, (box.nextMedia || {}).id]), []).includes(resp.data.id)) {
                console.log("Got same media again")
                setTimeout(() => {fetchNext(box)}, 500)
                return;
            }
            box.nextMedia = resp.data
            preloadMediaItem(box)
        })
        .catch(err => {
            // Try again
            setTimeout(() => {fetchNext(box)}, 1000)
            console.log(err)
        })
}

function mainLoop() {
    try {
    for (let box of boxes) {
        const now = new Date();
        const elapsed = box.prevChange == null ? null : ((now.getTime() - box.prevChange.getTime()) / 1000.0)
        let shouldChange = (box.prevChange == null || elapsed > changeSecs)
        if (box.currMedia && box.currMedia.mimeType.indexOf('video/') === 0) {
            let videoEl = document.querySelector("#" + box.id + " ." + box.videoIndex)
            shouldChange = shouldChange && elapsed > videoEl.duration;
        }
        const hasError = (box.currMedia || {}).error
        if (box.nextMedia && (shouldChange || hasError)) {
            log("Box " + box.id + " shouldChange" + (hasError ? " has error!" : ""))
            // If media is not ready, don't switch to it. Instead get a new media
            if (box.nextMediaReady) {
                box.currMedia = box.nextMedia;
                const infoEl = document.querySelector("#" + box.id + " .info");
                infoEl.innerHTML = "";
                if (box.currMedia && box.currMedia.mediaMetadata && box.currMedia.mediaMetadata.creationTime) {
                    infoEl.innerHTML = (new Date(box.currMedia.mediaMetadata.creationTime)).toLocaleDateString('fi');
                }
                box.nextMedia = null;
                box.prevChange = new Date();
                let imageEl = document.querySelector("#" + box.id + " .img")
                if (box.currMedia.mimeType.indexOf('video/') === 0) {
                    let videoEl = document.querySelector("#" + box.id + " ." + box.videoIndex)
                    imageEl.style.display = "none";
                    videoEl.style.display = 'inline';
                    videoEl.muted = true;
                    videoEl.play()
                    setTimeout(() => {
                        // Unmute
                        videoEl.muted = false;
                        videoEl.removeAttribute('muted');
                        if (videoEl.paused) {
                            // Crap, fall back!
                            videoEl.muted = true;
                            videoEl.setAttribute('muted', '');
                            videoEl.play();
                        }
                    }, 10)
                } else {
                    imageEl.style.display = "inline";
                    imageEl.setAttribute('src', buildFullUrl(box.currMedia))
                    let prevVideoEl = document.querySelector("#" + box.id + " ." + box.videoIndex)
                    if (prevVideoEl) {
                        prevVideoEl.style.display = "none";
                        if (prevVideoEl.stop != undefined) {
                            prevVideoEl.pause();
                            prevVideoEl.firstElementChild.removeAttribute('src'); // empty source
                            prevVideoEl.removeAttribute('src'); // empty source
                            prevVideoEl.load();
                            prevVideoEl.remove();
                        }
                        prevVideoEl.remove();
                    }
                }
            } else {
                log("Box " + box.id + " nextMediaReady was false!")
            }
            fetchNext(box)
        }
    }
    } catch (err) {
        initBoxes();
        for (let box of boxes) {
            fetchNext(box)
        }
        log(err)
    }
    setTimeout(mainLoop, 500)
}

initBoxes();
for (let box of boxes) {
    fetchNext(box)
}
mainLoop()

};
</script>
</body>
</html>