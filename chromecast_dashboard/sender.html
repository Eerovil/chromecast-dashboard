<html>
  <head>
    <title>Chromecast dashboard</title>

    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Cabin+Condensed:700">
    <link rel="icon" type="image/png" href="favicon.png">
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
  </head>
  <body>
    <p>
      Enter a Url for to display on dashboard and if the page does not update
      itself then enter an appropriate refresh interval in seconds.
    </p>
    <form method="get" action="JavaScript:connect();">
      <label>Url <input type="text" id="url" placeholder="http://www.gabenewell.org/"></label>
      <button type="submit">Launch</button>
    </form>
    <!-- For some reason the 'number' field stops form action from firing -->
    <label>Refresh <input type="number" id="refresh" min="0" value="0"></label>
    <button id="kill" disabled>Stop casting</button>
    <p id="post-note" style="display: none">
      If the page does not load please be sure HTTP header X-Frame-Options
      allows the page to be loaded inside a frame not on the same origin.
    </p>
  </body>

  <!-- Post load all the goods used to interact with Chromecast/receiver. -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script src="https://underscorejs.org/underscore-min.js"></script>
  <script>
  var applicationID = 'AC14F871';
var namespace = 'urn:x-cast:com.eerovil.chromecast-dashboard';
var session = null;

if (!chrome.cast || !chrome.cast.isAvailable) {
  setTimeout(initializeCastApi, 1000);
}

function initializeCastApi() {
  var sessionRequest = new chrome.cast.SessionRequest(applicationID);
  var apiConfig = new chrome.cast.ApiConfig(sessionRequest,
    sessionListener,
    receiverListener);

  chrome.cast.initialize(apiConfig, onInitSuccess, onError);
};

function onInitSuccess() {
  console.log('onInitSuccess');
}

function onError(message) {
  console.log('onError: ' + JSON.stringify(message));
}

function onSuccess(message) {
  console.log('onSuccess: ' + JSON.stringify(message));

  if (message['type'] == 'load') {
    $('#kill').prop('disabled', false);
    $('#post-note').show();
  }
}

function onStopAppSuccess() {
  console.log('onStopAppSuccess');

  $('#kill').prop('disabled', true);
  $('#post-note').hide();
}

function sessionListener(e) {
  console.log('New session ID: ' + e.sessionId);
  session = e;
  session.addUpdateListener(sessionUpdateListener);
}

function sessionUpdateListener(isAlive) {
  console.log((isAlive ? 'Session Updated' : 'Session Removed') + ': ' + session.sessionId);
  if (!isAlive) {
    session = null;
  }
};

function receiverListener(e) {
  // Due to API changes just ignore this.
}

function sendMessage(message) {
  if (session != null) {
    session.sendMessage(namespace, message, onSuccess.bind(this, message), onError);
  }
  else {
    chrome.cast.requestSession(function(e) {
      session = e;
      sessionListener(e);
      session.sendMessage(namespace, message, onSuccess.bind(this, message), onError);
    }, onError);
  }
}

function stopApp() {
  session.stop(onStopAppSuccess, onError);
}

function connect() {
  console.log('connect()');
  sendMessage({
    type: 'load',
    url: $('#url').val(),
    refresh: $('#refresh').val(),
  });
}

$('#kill').on('click', stopApp);

// Populate input fields from query params
$(function () {
  if (!'URLSearchParams' in window) {
    return;
  }

  var params = new URLSearchParams(window.location.search);
  if (params.has('url')) {
    $('#url').val(params.get('url'));
  }

  if (params.has('refresh')) {
    $('#refresh').val(params.get('refresh'));
  }
});
  </script>

</html>
